<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>방향키 리듬 게임</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            font-family: 'Arial', sans-serif;
            overflow: hidden; /* 스크롤 방지 */
        }
        canvas {
            background-color: #000;
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            text-align: center;
            pointer-events: none; /* 클릭 통과 */
        }
        h1 { margin: 0; font-size: 24px; color: #ddd; }
        #score-board { font-size: 20px; margin-top: 10px; }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border: 2px solid white;
            text-align: center;
            display: none; /* 평소엔 숨김 */
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background: #ffcc00;
            border: none;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover { background: #ffaa00; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>방향키 리듬 게임</h1>
        <div id="score-board">점수: 0 | 생명: 5</div>
    </div>

    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <div id="game-over">
        <h2 id="final-msg">GAME OVER</h2>
        <p id="final-score">최종 점수: 0</p>
        <button onclick="resetGame()">다시 하기</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreBoard = document.getElementById('score-board');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreText = document.getElementById('final-score');

        // 게임 설정 변수
        const LANES = [
            { key: 'ArrowLeft',  x: 50,  color: '#FF5555', symbol: '◄' },
            { key: 'ArrowDown',  x: 150, color: '#5555FF', symbol: '▼' },
            { key: 'ArrowUp',    x: 250, color: '#55FF55', symbol: '▲' },
            { key: 'ArrowRight', x: 350, color: '#FFFF55', symbol: '►' }
        ];

        const TARGET_Y = 500; // 판정선 위치
        const HIT_RANGE = 50; // 판정 범위
        
        let arrows = [];
        let score = 0;
        let lives = 5;
        let speed = 4;
        let frameCount = 0;
        let isGameOver = false;
        let animationId;

        // 화살표 클래스
        class Arrow {
            constructor(laneIndex) {
                this.lane = LANES[laneIndex];
                this.x = this.lane.x;
                this.y = -50; // 화면 위에서 시작
                this.laneIndex = laneIndex;
            }

            update() {
                this.y += speed;
            }

            draw() {
                ctx.fillStyle = this.lane.color;
                ctx.font = "bold 40px Arial";
                ctx.textAlign = "center";
                ctx.fillText(this.lane.symbol, this.x, this.y);
            }
        }

        // 게임 초기화
        function resetGame() {
            arrows = [];
            score = 0;
            lives = 5;
            speed = 4;
            frameCount = 0;
            isGameOver = false;
            gameOverScreen.style.display = 'none';
            updateUI();
            
            cancelAnimationFrame(animationId);
            gameLoop();
        }

        // UI 업데이트
        function updateUI() {
            scoreBoard.innerText = `점수: ${score} | 생명: ${lives}`;
        }

        // 게임 종료 처리
        function gameOver() {
            isGameOver = true;
            finalScoreText.innerText = `최종 점수: ${score}`;
            gameOverScreen.style.display = 'block';
            cancelAnimationFrame(animationId);
        }

        // 키 입력 처리 (이벤트 리스너)
        window.addEventListener('keydown', (e) => {
            if (isGameOver) return;

            // 눌린 키가 어느 레인인지 찾기
            const laneIdx = LANES.findIndex(l => l.key === e.code);
            if (laneIdx === -1) return; // 방향키가 아니면 무시

            // 해당 레인에 있는 화살표 중 판정선 근처에 있는 것 찾기
            // (가장 아래에 있는 화살표부터 확인)
            let hit = false;
            for (let i = 0; i < arrows.length; i++) {
                let a = arrows[i];
                if (a.laneIndex === laneIdx) {
                    // 거리 계산
                    let dist = Math.abs(a.y - TARGET_Y);
                    
                    if (dist < HIT_RANGE) {
                        // 명중!
                        arrows.splice(i, 1); // 화살표 제거
                        score += 10 + (speed * 2); // 속도가 빠르면 점수 더 줌
                        hit = true;
                        
                        // 시각적 효과 (간단히)
                        createHitEffect(a.x, TARGET_Y, a.lane.color);
                        break;
                    }
                }
            }
            
            // 빗나갔을 경우 (선택사항: 감점 혹은 무반응)
            if (hit) {
                // 속도 점진적 증가
                if (score % 50 === 0) speed += 0.5;
            }
            updateUI();
        });

        // 명중 효과 (반짝임)
        let effects = [];
        function createHitEffect(x, y, color) {
            effects.push({ x, y, color, life: 10 });
        }

        function drawEffects() {
            for (let i = effects.length - 1; i >= 0; i--) {
                let e = effects[i];
                ctx.strokeStyle = e.color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(e.x, e.y - 10, 30 - e.life, 0, Math.PI * 2);
                ctx.stroke();
                e.life--;
                if (e.life <= 0) effects.splice(i, 1);
            }
        }

        // 메인 게임 루프
        function gameLoop() {
            if (isGameOver) return;

            // 1. 화면 지우기
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. 배경 가이드 라인 그리기
            ctx.strokeStyle = "#555";
            ctx.lineWidth = 2;
            // 판정선
            ctx.beginPath();
            ctx.moveTo(0, TARGET_Y);
            ctx.lineTo(canvas.width, TARGET_Y);
            ctx.stroke();
            
            // 키 위치 표시 (빈 화살표)
            LANES.forEach(lane => {
                ctx.fillStyle = "#333";
                ctx.font = "bold 40px Arial";
                ctx.textAlign = "center";
                ctx.fillText(lane.symbol, lane.x, TARGET_Y);
                
                // 세로선 (트랙 구분)
                ctx.beginPath();
                ctx.moveTo(lane.x, 0);
                ctx.lineTo(lane.x, canvas.height);
                ctx.strokeStyle = "#222";
                ctx.stroke();
            });

            // 3. 화살표 생성 (랜덤)
            // 60프레임(약 1초)마다 생성하되, 속도가 빨라지면 더 자주 생성
            let spawnRate = Math.max(20, 60 - speed * 2);
            if (frameCount % Math.floor(spawnRate) === 0) {
                const randomLane = Math.floor(Math.random() * 4);
                arrows.push(new Arrow(randomLane));
            }

            // 4. 화살표 이동 및 그리기
            for (let i = arrows.length - 1; i >= 0; i--) {
                let a = arrows[i];
                a.update();
                a.draw();

                // 화면 밖으로 나가면 (놓침)
                if (a.y > canvas.height + 20) {
                    arrows.splice(i, 1);
                    lives--;
                    updateUI();
                    if (lives <= 0) gameOver();
                }
            }

            // 5. 효과 그리기
            drawEffects();

            frameCount++;
            animationId = requestAnimationFrame(gameLoop);
        }

        // 게임 시작
        resetGame();

    </script>
</body>
</html>
